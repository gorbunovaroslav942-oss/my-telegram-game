<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Tamagotchi 1256583707</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js?v=3"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root{--bg:#f4f4f7;}
        body,html{height:100%;margin:0;padding:0;overflow:hidden;background-color:var(--bg);font-family:sans-serif;}
        .app-container{display:flex;flex-direction:column;height:100vh;width:100%;align-items:center;}
        .header{width:100%;background:#fff;padding:12px 0;display:flex;justify-content:space-around;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.05);z-index:100;}
        .main{flex:1;width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;}
        .tab{display:none;width:100%;height:100%;flex-direction:column;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;}
        .active-tab{display:flex;}
        .pet-stage{flex:1;display:flex;align-items:center;justify-content:center;width:100%;}
        .pet-img{width:75%;max-width:300px;height:auto;animation:float 3s ease-in-out infinite;}
        @keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-15px);}}
        .action-area{width:95%;max-width:500px;display:grid;grid-template-columns:1fr 1fr;gap:15px;padding-bottom:30px;}
        .btn-custom{background:none;border:none;padding:0;cursor:pointer;outline:none;-webkit-tap-highlight-color:transparent;transition: all 0.3s ease;}
        .btn-custom img{width:100%;height:auto;display:block;border-radius:15px;}
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .navbar{width:100%;height:75px;background:#fff;display:flex;border-top:1px solid #ddd;padding-bottom:env(safe-area-inset-bottom);}
        .nav-item{flex:1;border:none;background:none;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#8e8e93;font-size:11px;cursor:pointer;}
        .active-nav{color:#0088cc!important;font-weight:bold;}
        
        /* –¢–æ–ø */
        #leaderboard-list { width: 100%; list-style: none; padding: 0; margin-top: 20px; }
        #leaderboard-list li { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; background: #fff; margin-bottom: 5px; border-radius: 8px; }
    </style>
</head>
<body>
<div class="app-container">
    <header class="header">
        <div style="font-weight:800;font-size:20px;">üêæ <span id="money">...</span></div>
        <div style="color:#666;font-size:14px;">üçñ <span id="hunger">...</span>%</div>
    </header>
    <main class="main">
        <div id="home" class="tab active-tab">
            <div class="pet-stage">
                <img id="pet-img" src="" class="pet-img">
            </div>
            <div class="action-area">
                <button id="btn-feed-parent" class="btn-custom" onclick="action('feed')">
                    <img id="img-feed" src="">
                </button>
                <button id="btn-play-parent" class="btn-custom" onclick="action('play')">
                    <img id="img-play" src="">
                </button>
            </div>
        </div>
        <div id="shop" class="tab"><h2>–ú–∞–≥–∞–∑–∏–Ω</h2><p>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞...</p></div>
        <div id="top" class="tab">
            <h2>–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
            <ul id="leaderboard-list">–ó–∞–≥—Ä—É–∑–∫–∞...</ul>
        </div>
    </main>
    <nav class="navbar">
        <button class="nav-item active-nav" onclick="switchTab(event,'home')">üè†<br>–ì–ª–∞–≤–Ω–∞—è</button>
        <button class="nav-item" onclick="switchTab(event,'shop')">üõí<br>–ú–∞–≥–∞–∑–∏–Ω</button>
        <button class="nav-item" onclick="switchTab(event,'top')">üèÜ<br>–¢–æ–ø</button>
    </nav>
</div>

<script>
// –¢–í–û–ô –ö–û–ù–§–ò–ì FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyAP_Rf44bvkeINAJWSuWz9DCgLqzmqG39k",
  authDomain: "tamagotchigame-2cc40.firebaseapp.com",
  projectId: "tamagotchigame-2cc40",
  storageBucket: "tamagotchigame-2cc40.firebasestorage.app",
  messagingSenderId: "1038723221462",
  appId: "1:1038723221462:web:0a0d6ee11b8b747e544677",
  measurementId: "G-QH00R44GJ8"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let tg = window.Telegram.WebApp;
tg.expand();

const userId = tg.initDataUnsafe?.user?.id || "1256583707";
const userName = tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫";
let state = { money: 100, hunger: 100 };

// –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø UI –ò –ö–ù–û–ü–û–ö
function updateUI() {
    document.getElementById('money').innerText = state.money;
    document.getElementById('hunger').innerText = Math.floor(state.hunger);
    
    // –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –∏–≥—Ä—ã –ø—Ä–∏ 0 —Å—ã—Ç–æ—Å—Ç–∏
    const playBtn = document.getElementById('btn-play-parent');
    if (Math.floor(state.hunger) <= 0) {
        playBtn.style.opacity = "0.4";
        playBtn.style.filter = "grayscale(1)";
    } else {
        playBtn.style.opacity = "1";
        playBtn.style.filter = "none";
    }
}

// –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
async function loadData() {
    try {
        const doc = await db.collection("users").doc(userId.toString()).get();
        if (doc.exists) {
            state = doc.data();
        } else {
            state = { money: 100, hunger: 100, name: userName };
            await db.collection("users").doc(userId.toString()).set(state);
        }
        updateUI();
    } catch (e) { console.error("Firebase load error:", e); }
}

// –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–•
async function saveData() {
    try {
        await db.collection("users").doc(userId.toString()).set({
            ...state,
            name: userName,
            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
    } catch (e) { console.error("Firebase save error:", e); }
}

// –õ–û–ì–ò–ö–ê –î–ï–ô–°–¢–í–ò–ô
async function action(type) {
    if (type === 'feed') {
        if (state.money < 10) {
            tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç! üêæ");
            return;
        }
        state.money -= 10;
        state.hunger = Math.min(100, state.hunger + 25);
        tg.HapticFeedback.notificationOccurred('success');
    } 
    
    else if (type === 'play') {
        // –ñ–ï–°–¢–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê
        if (Math.floor(state.hunger) <= 0) {
            tg.HapticFeedback.notificationOccurred('error');
            tg.showAlert("–ö–æ—Ç –≥–æ–ª–æ–¥–µ–Ω! üçñ");
            return; 
        }
        state.money += 15;
        state.hunger = Math.max(0, state.hunger - 15);
        tg.HapticFeedback.impactOccurred('medium');
    }
    
    updateUI();
    await saveData();
}

function switchTab(e, name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active-tab'));
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active-nav'));
    document.getElementById(name).classList.add('active-tab');
    e.currentTarget.classList.add('active-nav');
    if (name === 'top') loadLeaderboard();
}

async function loadLeaderboard() {
    const list = document.getElementById('leaderboard-list');
    list.innerHTML = "<li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>";
    try {
        const snapshot = await db.collection("users").orderBy("money", "desc").limit(10).get();
        list.innerHTML = "";
        snapshot.forEach(doc => {
            const data = doc.data();
            list.innerHTML += `<li><span>üë§ ${data.name || '–ò–≥—Ä–æ–∫'}</span> <b>${data.money} üêæ</b></li>`;
        });
    } catch (e) { list.innerHTML = "<li>–û—à–∏–±–∫–∞ —Ç–æ–ø–∞</li>"; }
}

// –¢–ê–ô–ú–ï–† –ì–û–õ–û–î–ê
setInterval(() => {
    if (state.hunger > 0) {
        state.hunger = Math.max(0, state.hunger - 1);
        updateUI();
    }
}, 10000);

// –ó–ê–ü–£–°–ö –ò –û–ë–•–û–î –ö–≠–®–ê –ö–ê–†–¢–ò–ù–û–ö
window.onload = () => {
    const v = Date.now();
    // –ü—Ä–æ–ø–∏—Å—ã–≤–∞–µ–º –ø—É—Ç–∏ –∫ —Ç–≤–æ–∏–º PNG —Ñ–∞–π–ª–∞–º —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∫–ª—é—á–æ–º
    document.getElementById('pet-img').src = "cat.png?v=" + v;
    document.getElementById('img-feed').src = "feed_btn.png?v=" + v;
    document.getElementById('img-play').src = "play_btn.png?v=" + v;
    
    loadData();
};
</script>
</body>
</html>
