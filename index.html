<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tamagotchi 1256583707</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root{--bg:#f4f4f7;}
body,html{height:100%;margin:0;padding:0;overflow:hidden;background-color:var(--bg);font-family:sans-serif;}
.app-container{display:flex;flex-direction:column;height:100vh;width:100%;align-items:center;}
.header{width:100%;background:#fff;padding:12px 0;display:flex;justify-content:space-around;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.05);z-index:100;}
.main{flex:1;width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.tab{display:none;width:100%;height:100%;flex-direction:column;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;}
.active-tab{display:flex;}
.pet-stage{flex:1;display:flex;align-items:center;justify-content:center;width:100%;}
.pet-img{width:75%;max-width:300px;height:auto;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-15px);}}
.action-area{width:95%;max-width:500px;display:grid;grid-template-columns:1fr 1fr;gap:10px;padding-bottom:20px;}
.btn-custom{background:transparent!important;border:none!important;padding:0!important;cursor:pointer;transform:scale(1.1);-webkit-tap-highlight-color:transparent;}
.btn-custom img{width:100%;height:auto;display:block;}
.navbar{width:100%;height:75px;background:#fff;display:flex;border-top:1px solid #ddd;padding-bottom:env(safe-area-inset-bottom);}
.nav-item{flex:1;border:none;background:none;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#8e8e93;font-size:11px;}
.active-nav{color:#0088cc!important;}
#leaderboard-list { width: 100%; list-style: none; padding: 0; margin-top: 20px; }
#leaderboard-list li { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; background: #fff; margin-bottom: 5px; border-radius: 8px; }
</style>
</head>
<body>
<div class="app-container">
    <header class="header">
        <div style="font-weight:800;font-size:20px;">üêæ <span id="money">...</span></div>
        <div style="color:#666;font-size:14px;">üçñ <span id="hunger">...</span>%</div>
    </header>
    <main class="main">
        <div id="home" class="tab active-tab">
            <div class="pet-stage">
                <img id="pet-img" src="cat.jpg" class="pet-img">
            </div>
            <div class="action-area">
                <button class="btn-custom" onclick="action('feed')"><img id="img-feed" src="feed_btn.jpg"></button>
                <button class="btn-custom" onclick="action('play')"><img id="img-play" src="play_btn.jpg"></button>
            </div>
        </div>
        <div id="shop" class="tab"><h2>–ú–∞–≥–∞–∑–∏–Ω</h2><p>–¢–æ–≤–∞—Ä—ã –ø–æ—è–≤—è—Ç—Å—è —Å–∫–æ—Ä–æ!</p></div>
        <div id="top" class="tab">
            <h2>–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
            <ul id="leaderboard-list">–ó–∞–≥—Ä—É–∑–∫–∞...</ul>
        </div>
    </main>
    <nav class="navbar">
        <button class="nav-item active-nav" onclick="switchTab(event,'home')"><span>üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
        <button class="nav-item" onclick="switchTab(event,'shop')"><span>üõí</span><span>–ú–∞–≥–∞–∑–∏–Ω</span></button>
        <button class="nav-item" onclick="switchTab(event,'top')"><span>üèÜ</span><span>–¢–æ–ø</span></button>
    </nav>
</div>

<script>
// –¢–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAP_Rf44bvkeINAJWSuWz9DCgLqzmqG39k",
  authDomain: "tamagotchigame-2cc40.firebaseapp.com",
  projectId: "tamagotchigame-2cc40",
  storageBucket: "tamagotchigame-2cc40.firebasestorage.app",
  messagingSenderId: "1038723221462",
  appId: "1:1038723221462:web:0a0d6ee11b8b747e544677",
  measurementId: "G-QH00R44GJ8"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let tg = window.Telegram.WebApp;
tg.expand();

const userId = tg.initDataUnsafe?.user?.id || "1256583707";
const userName = tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫";

let state = { money: 100, hunger: 100 };

async function loadData() {
    try {
        const doc = await db.collection("users").doc(userId.toString()).get();
        if (doc.exists) {
            state = doc.data();
        } else {
            state = { money: 100, hunger: 100, name: userName };
            await db.collection("users").doc(userId.toString()).set(state);
        }
        updateUI();
    } catch (e) { console.error("Load error:", e); }
}

async function saveData() {
    try {
        await db.collection("users").doc(userId.toString()).set({
            ...state,
            name: userName,
            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
    } catch (e) { console.error("Save error:", e); }
}

function updateUI() {
    document.getElementById('money').innerText = state.money;
    document.getElementById('hunger').innerText = Math.floor(state.hunger);
}

async function action(type) {
    if(type === 'feed' && state.money >= 10){
        state.money -= 10;
        state.hunger = Math.min(100, state.hunger + 25);
        tg.HapticFeedback.notificationOccurred('success');
    } else if(type === 'play'){
        state.money += 15;
        state.hunger = Math.max(0, state.hunger - 15);
        tg.HapticFeedback.impactOccurred('medium');
    }
    updateUI();
    await saveData();
}

function switchTab(e, name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active-tab'));
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active-nav'));
    document.getElementById(name).classList.add('active-tab');
    e.currentTarget.classList.add('active-nav');
    if (name === 'top') loadLeaderboard();
}

async function loadLeaderboard() {
    const list = document.getElementById('leaderboard-list');
    list.innerHTML = "<li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>";
    try {
        const snapshot = await db.collection("users").orderBy("money", "desc").limit(10).get();
        list.innerHTML = "";
        snapshot.forEach(doc => {
            const data = doc.data();
            list.innerHTML += `<li><span>üë§ ${data.name || '–ê–Ω–æ–Ω–∏–º'}</span> <b>${data.money} üêæ</b></li>`;
        });
    } catch (e) { list.innerHTML = "<li>–û—à–∏–±–∫–∞ —Ç–æ–ø–∞</li>"; }
}

setInterval(() => {
    if (state.hunger > 0) {
        state.hunger = Math.max(0, state.hunger - 1);
        updateUI();
    }
}, 8000);

window.onload = async () => {
    await loadData();
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É—Ç–µ–π –∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º –Ω–∞ .jpg
    const v = Date.now();
    document.getElementById('pet-img').src = "cat.jpg?v=" + v;
    document.getElementById('img-feed').src = "feed_btn.jpg?v=" + v;
    document.getElementById('img-play').src = "play_btn.jpg?v=" + v;
};
</script>
</body>
</html>
