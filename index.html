let tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready(); // Сообщаем Telegram, что приложение готово

    // Загрузка состояния с проверкой на валидность
    let state = JSON.parse(localStorage.getItem('pet_v_final')) || { money: 100, hunger: 100 };

    function updateUI() {
        const moneyEl = document.getElementById('money');
        const hungerEl = document.getElementById('hunger');
        
        moneyEl.innerText = state.money;
        hungerEl.innerText = Math.floor(state.hunger);

        // Визуальное предупреждение, если питомец голоден
        hungerEl.parentElement.style.color = state.hunger < 20 ? "#ff3b30" : "#666";

        localStorage.setItem('pet_v_final', JSON.stringify(state));
    }

    function action(type) {
        if (type === 'feed') {
            if (state.money >= 10 && state.hunger < 100) {
                state.money -= 10;
                state.hunger = Math.min(100, state.hunger + 25);
                tg.HapticFeedback.notificationOccurred('success');
            } else if (state.money < 10) {
                tg.HapticFeedback.notificationOccurred('error');
                alert("Недостаточно монет!");
            }
        } else if (type === 'play') {
            if (state.hunger > 10) {
                state.money += 15;
                state.hunger = Math.max(0, state.hunger - 15);
                tg.HapticFeedback.impactOccurred('medium');
            } else {
                tg.HapticFeedback.notificationOccurred('warning');
                alert("Питомец слишком голоден для игр!");
            }
        }
        updateUI();
    }

    function switchTab(e, name) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active-tab'));
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active-nav'));
        document.getElementById(name).classList.add('active-tab');
        e.currentTarget.classList.add('active-nav');
        tg.HapticFeedback.selectionChanged();
    }

    // Пассивное уменьшение голода (раз в 10 секунд для баланса)
    setInterval(() => {
        if (state.hunger > 0) {
            state.hunger = Math.max(0, state.hunger - 1);
            updateUI();
        }
    }, 10000);

    window.onload = () => {
        // Добавляем версию к картинкам для обхода кэша (антикеш)
        const v = Date.now();
        const images = {
            'img-feed': 'feed_btn.png',
            'img-play': 'play_btn.png',
            'pet-img': 'cat.png'
        };
        
        for (let id in images) {
            const el = document.getElementById(id);
            if (el) el.src = `${images[id]}?v=${v}`;
        }
        updateUI();
    };
